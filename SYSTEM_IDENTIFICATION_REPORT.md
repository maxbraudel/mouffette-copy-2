# üîê RAPPORT COMPLET - SYST√àMES D'IDENTIFICATION MOUFFETTE

**Date**: 29 Octobre 2025  
**Application**: Mouffette - Syst√®me de partage multim√©dia temps r√©el  
**Auteur**: Analyse technique approfondie

---

## üìã TABLE DES MATI√àRES

1. [Vue d'ensemble](#vue-densemble)
2. [Identification des Clients](#identification-des-clients)
3. [Identification des M√©dias](#identification-des-m√©dias)
4. [Identification des Fichiers](#identification-des-fichiers)
5. [Identification des Sessions](#identification-des-sessions)
6. [Identification des Id√©es (Sc√®nes)](#identification-des-id√©es-sc√®nes)
7. [Flux de Connexion D√©taill√©](#flux-de-connexion-d√©taill√©)
8. [Diagramme Complet](#diagramme-complet)
9. [Cas d'Usage Critiques](#cas-dusage-critiques)

---

## 1. VUE D'ENSEMBLE

L'application Mouffette utilise **5 syst√®mes d'identification distincts et compl√©mentaires** :

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    MOUFFETTE                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  1. Persistent Client ID  (identit√© stable client)  ‚îÇ
‚îÇ  2. Session ID            (session r√©seau √©ph√©m√®re) ‚îÇ
‚îÇ  3. Media ID              (item canvas unique)      ‚îÇ
‚îÇ  4. File ID               (fichier unique)          ‚îÇ
‚îÇ  5. Idea ID               (sc√®ne/projet)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Principe cl√©** : Chaque syst√®me d'identification r√©pond √† un besoin sp√©cifique et ne doit **jamais** √™tre confondu avec un autre.

---

## 2. IDENTIFICATION DES CLIENTS

### 2.1 Persistent Client ID

**R√¥le** : Identit√© **STABLE** et **PERMANENTE** d'une installation client sur une machine.

#### G√©n√©ration
**Localisation** : `MainWindow.cpp` ligne 656

```cpp
QString persistentClientId = QUuid::createUuid().toString(QUuid::WithoutBraces);
// Exemple : "3f8c7d2a-5b1e-4f6d-9a2c-1b3d4e5f6g7h"
```

#### Stockage
**M√©thode** : `QSettings` (persiste sur disque)

**Cl√© composite** :
```cpp
QString settingsKey = "persistentClientId_{machineId}_{installHash}_{instanceSuffix}"
```

Composants de la cl√© :
1. **machineId** : `QSysInfo::machineUniqueId()` ou hostname
2. **installHash** : SHA1 des 16 premiers caract√®res du chemin d'installation
3. **instanceSuffix** : Optionnel, pour multi-instance sur m√™me machine

**Exemple de cl√©** :
```
persistentClientId_MacBookPro_a1b2c3d4e5f6g7h8_dev1
```

#### Caract√©ristiques
- ‚úÖ **PERSISTE** entre red√©marrages
- ‚úÖ **PERSISTE** entre reconnexions r√©seau
- ‚úÖ **UNIQUE** par installation (support multi-instance)
- ‚úÖ **SURVIT** aux coupures r√©seau
- ‚ùå **NE CHANGE JAMAIS** (sauf r√©installation compl√®te)

#### Usage
**Dans le protocole** :
- Envoy√© dans le message `register` au serveur
- Utilis√© comme identifiant principal dans `client_list`
- Cl√© pour toutes les associations c√¥t√© serveur

**C√¥t√© client** :
```cpp
m_webSocketClient->setPersistentClientId(persistentClientId);
```

**C√¥t√© serveur** :
```javascript
client.persistentId = persistentId; // Stock√© dans l'objet client
this.registerSessionForPersistent(persistentId, sessionId);
```

---

### 2.2 Session ID

**R√¥le** : Identifiant **√âPH√âM√àRE** d'une connexion WebSocket sp√©cifique.

#### G√©n√©ration
**Localisation** : `WebSocketClient.cpp` ligne 16

```cpp
m_sessionId = QUuid::createUuid().toString(QUuid::WithoutBraces);
// Nouvelle valeur √† CHAQUE lancement du client
```

**C√¥t√© serveur** : `server.js` ligne 70
```javascript
const clientId = uuidv4(); // Nouveau UUID par connexion socket
```

#### Caract√©ristiques
- ‚úÖ **NOUVEAU** √† chaque d√©marrage de l'application
- ‚úÖ **NOUVEAU** √† chaque reconnexion WebSocket
- ‚úÖ **UNIQUE** par socket WebSocket
- ‚ùå **NE PERSISTE PAS** entre red√©marrages
- ‚ùå **CHANGE** √† chaque reconnexion

#### Usage Principal
**Client ‚Üí Serveur** :
```cpp
message["sessionId"] = m_sessionId; // Dans register()
```

**Serveur - Fusion de sessions** :
```javascript
// Si m√™me persistentId ET m√™me sessionId d√©tect√©s
if (existingSession && existingSession !== client) {
    // Fusion : nouvelle socket remplace l'ancienne
    console.log(`üîÑ Client session reconnecting: ${persistentId}`);
    // L'ancienne socket est ferm√©e, la nouvelle h√©rite de l'√©tat
}
```

#### Cas de Reconnexion

**Sc√©nario 1 : Red√©marrage complet du client**
```
1. Client d√©marre ‚Üí Nouveau sessionId g√©n√©r√© (ex: "abc123")
2. Client se connecte ‚Üí Envoie persistentId + sessionId
3. Serveur d√©tecte : m√™me persistentId, NOUVEAU sessionId
4. Serveur fusionne : r√©cup√®re l'√©tat de l'ancien sessionId
```

**Sc√©nario 2 : Perte r√©seau temporaire**
```
1. Client perd connexion (WiFi coup√©)
2. Client se reconnecte ‚Üí M√äME sessionId (pas de red√©marrage)
3. Serveur d√©tecte : m√™me persistentId + m√™me sessionId
4. Serveur restaure la session exacte
```

---

### 2.3 Diff√©rence Critique : Persistent vs Session

| Aspect | Persistent Client ID | Session ID |
|--------|---------------------|-----------|
| **Dur√©e de vie** | Permanente (sauf r√©install) | Temporaire (par lancement) |
| **G√©n√©ration** | Une fois, au premier lancement | √Ä chaque d√©marrage client |
| **Stockage** | QSettings (disque) | M√©moire uniquement |
| **Usage** | Identit√© logique stable | Tracking connexion r√©seau |
| **Reconnexion** | Toujours le m√™me | Nouveau √† chaque reboot |
| **Multi-instance** | Un par installation | Un par processus |

**Analogie** :
- **Persistent Client ID** = Num√©ro de s√©curit√© sociale (permanent)
- **Session ID** = Num√©ro de ticket de caisse (√©ph√©m√®re)

---

## 3. IDENTIFICATION DES M√âDIAS

### 3.1 Media ID

**R√¥le** : Identifiant **UNIQUE** d'un √©l√©ment graphique sur le canvas.

#### G√©n√©ration
**Localisation** : `MediaItems.cpp` (constructeur)

```cpp
ResizableMediaBase::ResizableMediaBase(...)
    : m_mediaId(QUuid::createUuid().toString(QUuid::WithoutBraces))
{
    // Chaque item cr√©√© sur le canvas a un UUID unique
}
```

#### Caract√©ristiques
- ‚úÖ **UNIQUE** par item graphique sur le canvas
- ‚úÖ **PERSISTE** tant que l'item existe dans la sc√®ne
- ‚úÖ **DIFF√âRENT** pour chaque copie du m√™me fichier
- ‚ùå **DISPARA√éT** quand l'item est supprim√©
- ‚ùå **PAS PARTAG√â** entre clients (local au canvas)

#### Exemple Concret

**Sc√©nario** : Vous ajoutez 3 fois la m√™me image `chat.jpg` sur le canvas

```
Canvas contient :
  - Item 1: mediaId="aaa111" ‚Üí chat.jpg
  - Item 2: mediaId="bbb222" ‚Üí chat.jpg  (m√™me fichier, autre item)
  - Item 3: mediaId="ccc333" ‚Üí chat.jpg  (m√™me fichier, autre item)
```

**Chaque item est ind√©pendant** :
- Position diff√©rente
- Taille diff√©rente
- Opacit√© diff√©rente
- √âtat d'upload diff√©rent

#### Usage

**Association media ‚Üí file** :
```cpp
FileManager::associateMediaWithFile(mediaId, fileId);
// mediaId "aaa111" ‚Üí fileId "xyz789" (hash de chat.jpg)
// mediaId "bbb222" ‚Üí fileId "xyz789" (M√äME fileId !)
// mediaId "ccc333" ‚Üí fileId "xyz789" (M√äME fileId !)
```

**Tracking UI** :
```cpp
media->setUploadUploading(50); // Progress bar sur cet item sp√©cifique
```

**IMPORTANT** : Le `mediaId` n'est **JAMAIS** envoy√© au serveur ou aux autres clients. C'est un identifiant purement local.

---

## 4. IDENTIFICATION DES FICHIERS

### 4.1 File ID

**R√¥le** : Identifiant **UNIQUE et D√âTERMINISTE** d'un fichier physique sur le disque.

#### G√©n√©ration
**Localisation** : `LocalFileRepository.cpp` ligne 10

```cpp
QString LocalFileRepository::generateFileId(const QString& filePath) const {
    QFileInfo fileInfo(filePath);
    QString canonicalPath = fileInfo.canonicalFilePath();
    
    QByteArray pathBytes = canonicalPath.toUtf8();
    QByteArray hash = QCryptographicHash::hash(pathBytes, QCryptographicHash::Sha256);
    
    return QString::fromLatin1(hash.toHex());
    // Exemple : "4f8a9c2d1b3e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6"
}
```

#### Algorithme de G√©n√©ration

**√âtape 1** : R√©solution du chemin canonique
```cpp
QString canonicalPath = fileInfo.canonicalFilePath();
// /Users/max/Pictures/chat.jpg ‚Üí /Users/max/Pictures/chat.jpg
// (r√©sout les liens symboliques, relatifs, etc.)
```

**√âtape 2** : Hash SHA-256 du chemin
```cpp
QByteArray hash = QCryptographicHash::hash(pathBytes, QCryptographicHash::Sha256);
// Produit un hash de 64 caract√®res hexad√©cimaux
```

#### Caract√©ristiques CRITIQUES

‚úÖ **D√âTERMINISTE** : M√™me fichier ‚Üí TOUJOURS m√™me fileId
```cpp
getOrCreateFileId("/path/to/chat.jpg"); // ‚Üí "4f8a9c2d..."
getOrCreateFileId("/path/to/chat.jpg"); // ‚Üí "4f8a9c2d..." (M√äME)
```

‚úÖ **D√âDUPLICATION AUTOMATIQUE**
```
Canvas :
  - Item 1 (mediaId aaa111) ‚Üí /path/chat.jpg ‚Üí fileId xyz789
  - Item 2 (mediaId bbb222) ‚Üí /path/chat.jpg ‚Üí fileId xyz789 (M√äME)
  - Item 3 (mediaId ccc333) ‚Üí /path/autre.jpg ‚Üí fileId def456 (DIFF√âRENT)

Upload : Seulement 2 fichiers envoy√©s (xyz789 et def456), pas 3 !
```

‚úÖ **PARTAG√â ENTRE M√âDIAS** : Plusieurs `mediaId` peuvent pointer vers le m√™me `fileId`

‚ùå **D√âPEND DU CHEMIN** : Si le fichier est d√©plac√©, nouveau fileId g√©n√©r√©

#### Usage Principal

**D√©duplication upload** :
```cpp
// BuildMediaManifest() dans MainWindow.cpp
QSet<QString> processedFileIds; // √âvite les doublons

for (auto* media : allMediaItems) {
    QString fileId = fileManager->getFileIdForMedia(media->mediaId());
    if (!processedFileIds.contains(fileId)) {
        files.append({fileId, media->mediaId(), path, ...});
        processedFileIds.insert(fileId);
    }
    // Les doublons sont automatiquement ignor√©s !
}
```

**Tracking upload c√¥t√© serveur** :
```javascript
// server.js - handleUploadComplete
const persistentId = this.getPersistentId(senderId);
let filesByIdea = this.clientFiles.get(persistentId);
if (!filesByIdea) {
    filesByIdea = new Map();
    this.clientFiles.set(persistentId, filesByIdea);
}
let fileSet = filesByIdea.get(ideaId);
if (!fileSet) {
    fileSet = new Set();
    filesByIdea.set(ideaId, fileSet);
}
for (const fileId of upload.files) {
    fileSet.add(fileId); // Tracking : ce client a ce fichier pour cette id√©e
}
```

---

## 5. IDENTIFICATION DES SESSIONS (Canvas)

### 5.1 Canvas Session

**R√¥le** : Conteneur d'√©tat pour un client distant sp√©cifique (un canvas par client distant).

#### Structure
**Localisation** : `SessionManager.h`

```cpp
struct CanvasSession {
    QString persistentClientId;  // Client cible (STABLE)
    QString serverAssignedId;    // Session serveur (√âPH√âM√àRE)
    QString ideaId;              // Sc√®ne active (voir section 6)
    ScreenCanvas* canvas;        // Widget Qt du canvas
    QPushButton* uploadButton;   // Bouton d'upload associ√©
    ClientInfo lastClientInfo;   // Dernier √©tat connu du client
    QSet<QString> expectedIdeaFileIds;   // Fichiers attendus sur ce canvas
    QSet<QString> knownRemoteFileIds;    // Fichiers confirm√©s sur le client distant
    UploadTracking upload;       // √âtat upload/progress
};
```

#### Gestion
**Par SessionManager** :
```cpp
// MainWindow.cpp
CanvasSession& session = m_sessionManager->getOrCreateSession(persistentClientId, clientInfo);
```

**Lookup par persistentClientId** :
```cpp
CanvasSession* session = m_sessionManager->findSession(persistentClientId);
```

**Lookup par ideaId** :
```cpp
CanvasSession* session = m_sessionManager->findSessionByIdeaId(ideaId);
```

**Lookup par serverSessionId** :
```cpp
CanvasSession* session = m_sessionManager->findSessionByServerClientId(serverSessionId);
```

#### Cycle de Vie

**Cr√©ation** : Quand un client distant appara√Æt dans `client_list`
```cpp
ensureCanvasSession(clientInfo);
```

**Persistance** : Tant que le client distant est connu (m√™me d√©connect√©)

**Suppression** : Uniquement sur demande explicite ou cleanup app

---

## 6. IDENTIFICATION DES ID√âES (SC√àNES)

### 6.1 Idea ID

**R√¥le** : Identifiant d'un **projet/sc√®ne logique** associ√© √† un canvas sp√©cifique.

#### G√©n√©ration
**Localisation** : `MainWindow.cpp` ligne 1741

```cpp
QString MainWindow::createIdeaId() const {
    return QUuid::createUuid().toString(QUuid::WithoutBraces);
    // Exemple : "9z8y7x6w-5v4u-3t2s-1r0q-p9o8n7m6l5k4"
}
```

#### G√©n√©ration Automatique
**Quand ?** :
1. Cr√©ation d'une nouvelle `CanvasSession`
2. Rotation d'id√©e (apr√®s clear canvas)

```cpp
void MainWindow::rotateSessionIdea(CanvasSession& session) {
    const QString oldIdeaId = session.ideaId;
    session.ideaId = createIdeaId(); // NOUVEAU UUID
    session.expectedIdeaFileIds.clear();
    session.knownRemoteFileIds.clear();
    m_fileManager->removeIdeaAssociations(oldIdeaId);
}
```

#### Caract√©ristiques

‚úÖ **UN PAR CANVAS** : Chaque canvas a son propre ideaId unique
‚úÖ **ASSOCIE FICHIERS** : Tous les fichiers sur un canvas partagent le m√™me ideaId
‚úÖ **OBLIGATOIRE** : Toutes les op√©rations serveur n√©cessitent un ideaId (Phase 3)
‚úÖ **ROTATION** : Nouveau ideaId quand on efface le canvas pour repartir √† z√©ro

#### Usage Serveur

**Tracking fichiers par id√©e** :
```javascript
// Structure serveur
this.clientFiles = new Map(); 
// persistentClientId ‚Üí Map(ideaId ‚Üí Set(fileId))

// Exemple :
clientFiles.get("client-abc123") = {
    "idea-001": Set(["file-xyz", "file-def"]),  // Canvas 1
    "idea-002": Set(["file-ghi"])               // Canvas 2 (autre session)
}
```

**Protocole** :
```javascript
// Tous ces messages DOIVENT contenir ideaId
upload_start      ‚Üí ideaId (obligatoire)
upload_complete   ‚Üí ideaId (obligatoire)
remove_all_files  ‚Üí ideaId (obligatoire)
remove_file       ‚Üí ideaId (obligatoire)
```

#### Exemple Concret

**Sc√©nario** : Vous travaillez avec 2 clients distants

```
Client A (persistentId: "aaa111")
  ‚îú‚îÄ Canvas A1 (ideaId: "idea-001")
  ‚îÇ    ‚îú‚îÄ media1 ‚Üí fileId "xyz789"
  ‚îÇ    ‚îî‚îÄ media2 ‚Üí fileId "abc456"
  ‚îî‚îÄ (pas d'autre canvas pour ce client)

Client B (persistentId: "bbb222")
  ‚îú‚îÄ Canvas B1 (ideaId: "idea-002")
  ‚îÇ    ‚îî‚îÄ media3 ‚Üí fileId "def789"
  ‚îî‚îÄ (pas d'autre canvas pour ce client)
```

**C√¥t√© serveur** :
```javascript
clientFiles = {
    "aaa111": {
        "idea-001": Set(["xyz789", "abc456"])
    },
    "bbb222": {
        "idea-002": Set(["def789"])
    }
}
```

---

## 7. FLUX DE CONNEXION D√âTAILL√â

### 7.1 D√©marrage Client (Premi√®re Fois)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. Application d√©marre                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. MainWindow::MainWindow()                    ‚îÇ
‚îÇ    - Lit QSettings pour persistentClientId     ‚îÇ
‚îÇ    - PAS TROUV√â (premi√®re fois)                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. G√©n√©ration Persistent Client ID             ‚îÇ
‚îÇ    QString persistentClientId =                ‚îÇ
‚îÇ      QUuid::createUuid().toString()            ‚îÇ
‚îÇ    ‚Üí "3f8c7d2a-5b1e-4f6d-9a2c-1b3d4e5f6g7h"   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. Stockage QSettings                          ‚îÇ
‚îÇ    settings.setValue(settingsKey,              ‚îÇ
‚îÇ                      persistentClientId)       ‚îÇ
‚îÇ    ‚Üí Sauvegard√© sur disque                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. Configuration WebSocketClient               ‚îÇ
‚îÇ    m_webSocketClient->setPersistentClientId(   ‚îÇ
‚îÇ        persistentClientId)                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 6. WebSocketClient::WebSocketClient()          ‚îÇ
‚îÇ    - G√©n√®re sessionId (nouveau UUID)           ‚îÇ
‚îÇ    m_sessionId = QUuid::createUuid()           ‚îÇ
‚îÇ    ‚Üí "abc123-def456-ghi789-jkl012"            ‚îÇ
‚îÇ    - m_clientId = m_sessionId (init)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 7. connectToServer()                           ‚îÇ
‚îÇ    m_webSocket->open(serverUrl)                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 8. Serveur : nouvelle connexion WebSocket     ‚îÇ
‚îÇ    const clientId = uuidv4()                   ‚îÇ
‚îÇ    ‚Üí "server-socket-123"                       ‚îÇ
‚îÇ    clientInfo = {                              ‚îÇ
‚îÇ      id: "server-socket-123",                  ‚îÇ
‚îÇ      sessionId: "server-socket-123",           ‚îÇ
‚îÇ      persistentId: null,  ‚Üê PAS ENCORE CONNU   ‚îÇ
‚îÇ      ws: [WebSocket object]                    ‚îÇ
‚îÇ    }                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 9. Serveur envoie welcome                     ‚îÇ
‚îÇ    {                                           ‚îÇ
‚îÇ      type: "welcome",                          ‚îÇ
‚îÇ      clientId: "server-socket-123"             ‚îÇ
‚îÇ    }                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 10. Client re√ßoit welcome                     ‚îÇ
‚îÇ     m_clientId = "server-socket-123"           ‚îÇ
‚îÇ     ‚Üê Remplace le sessionId temporaire         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 11. Client envoie register                    ‚îÇ
‚îÇ     {                                          ‚îÇ
‚îÇ       type: "register",                        ‚îÇ
‚îÇ       clientId: "3f8c7d2a-...",  ‚Üê PERSISTENT  ‚îÇ
‚îÇ       sessionId: "abc123-...",   ‚Üê SESSION     ‚îÇ
‚îÇ       machineName: "MacBook Pro",              ‚îÇ
‚îÇ       screens: [...],                          ‚îÇ
‚îÇ       platform: "macOS"                        ‚îÇ
‚îÇ     }                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 12. Serveur handleRegister()                  ‚îÇ
‚îÇ     client.persistentId = "3f8c7d2a-..."      ‚îÇ
‚îÇ     client.sessionId = "abc123-..."            ‚îÇ
‚îÇ     registerSessionForPersistent(              ‚îÇ
‚îÇ       "3f8c7d2a-...", "abc123-...")           ‚îÇ
‚îÇ                                                ‚îÇ
‚îÇ     sessionsByPersistent = {                   ‚îÇ
‚îÇ       "3f8c7d2a-...": Set(["abc123-..."])     ‚îÇ
‚îÇ     }                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 13. Serveur envoie registration_confirmed     ‚îÇ
‚îÇ     + state_sync (si fichiers existants)      ‚îÇ
‚îÇ     + broadcastClientList()                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 14. CLIENT CONNECT√â ET ENREGISTR√â ‚úÖ          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### 7.2 Red√©marrage Client (D√©j√† Enregistr√©)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. Application red√©marre                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. MainWindow::MainWindow()                    ‚îÇ
‚îÇ    - Lit QSettings pour persistentClientId     ‚îÇ
‚îÇ    - TROUV√â : "3f8c7d2a-..."  ‚úÖ               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. R√©utilisation Persistent Client ID          ‚îÇ
‚îÇ    persistentClientId = "3f8c7d2a-..."         ‚îÇ
‚îÇ    ‚Üê M√äME QUE LA DERNI√àRE FOIS                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. Configuration WebSocketClient               ‚îÇ
‚îÇ    m_webSocketClient->setPersistentClientId(   ‚îÇ
‚îÇ        "3f8c7d2a-...")                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. WebSocketClient::WebSocketClient()          ‚îÇ
‚îÇ    - G√©n√®re NOUVEAU sessionId                  ‚îÇ
‚îÇ    m_sessionId = QUuid::createUuid()           ‚îÇ
‚îÇ    ‚Üí "zzz999-yyy888-xxx777"  ‚Üê DIFF√âRENT !     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 6-10. Connexion identique (welcome, etc.)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 11. Client envoie register                    ‚îÇ
‚îÇ     {                                          ‚îÇ
‚îÇ       clientId: "3f8c7d2a-...",  ‚Üê M√äME !      ‚îÇ
‚îÇ       sessionId: "zzz999-...",   ‚Üê NOUVEAU !   ‚îÇ
‚îÇ       ...                                      ‚îÇ
‚îÇ     }                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 12. Serveur handleRegister()                  ‚îÇ
‚îÇ     - D√©tecte M√äME persistentId                ‚îÇ
‚îÇ     - D√©tecte NOUVEAU sessionId                ‚îÇ
‚îÇ     - Fusionne avec ancienne session           ‚îÇ
‚îÇ       (r√©cup√®re machineId, screens, etc.)      ‚îÇ
‚îÇ     - Ferme ancienne socket                    ‚îÇ
‚îÇ     - Nouvelle socket devient active           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 13. Serveur envoie state_sync                 ‚îÇ
‚îÇ     {                                          ‚îÇ
‚îÇ       type: "state_sync",                      ‚îÇ
‚îÇ       ideas: {                                 ‚îÇ
‚îÇ         "idea-001": ["file-xyz", "file-abc"],  ‚îÇ
‚îÇ         "idea-002": ["file-def"]               ‚îÇ
‚îÇ       }                                        ‚îÇ
‚îÇ     }                                          ‚îÇ
‚îÇ     ‚Üê Restaure tous les fichiers upload√©s     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 14. CLIENT RECONNECT√â AVEC √âTAT RESTAUR√â ‚úÖ   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Points Cl√©s** :
- ‚úÖ `persistentClientId` : **IDENTIQUE** (r√©cup√©r√© depuis QSettings)
- üîÑ `sessionId` : **NOUVEAU** (g√©n√©r√© √† chaque d√©marrage)
- üîÑ Socket WebSocket : **NOUVELLE** connexion
- ‚úÖ √âtat serveur : **RESTAUR√â** automatiquement

---

### 7.3 Reconnexion R√©seau (M√™me Session)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. Client connect√© et actif                   ‚îÇ
‚îÇ    persistentId: "3f8c7d2a-..."               ‚îÇ
‚îÇ    sessionId: "abc123-..."                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. Perte r√©seau (WiFi coup√©, etc.)           ‚îÇ
‚îÇ    WebSocket: disconnected                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. Client d√©tecte perte connexion             ‚îÇ
‚îÇ    onDisconnected()                            ‚îÇ
‚îÇ    - m_reconnectTimer d√©marre                  ‚îÇ
‚îÇ    - Tentatives de reconnexion                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. R√©seau revient                             ‚îÇ
‚îÇ    attemptReconnect()                          ‚îÇ
‚îÇ    m_webSocket->open(serverUrl)                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. Nouvelle socket WebSocket ouverte          ‚îÇ
‚îÇ    ‚Üê MAIS : sessionId INCHANG√â (pas reboot)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 6. Serveur : nouvelle connexion               ‚îÇ
‚îÇ    Nouveau socket ID assign√©                   ‚îÇ
‚îÇ    ‚Üí "server-socket-456"  ‚Üê NOUVEAU            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 7. Client envoie register                     ‚îÇ
‚îÇ    {                                           ‚îÇ
‚îÇ      clientId: "3f8c7d2a-...",  ‚Üê M√äME         ‚îÇ
‚îÇ      sessionId: "abc123-...",   ‚Üê M√äME !       ‚îÇ
‚îÇ      ...                                       ‚îÇ
‚îÇ    }                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 8. Serveur handleRegister()                   ‚îÇ
‚îÇ    - D√©tecte : M√äME persistentId + sessionId   ‚îÇ
‚îÇ    - Trouve session existante (d√©connect√©e)    ‚îÇ
‚îÇ    - R√©assigne nouvelle socket                 ‚îÇ
‚îÇ    - RESTAURE √©tat complet                     ‚îÇ
‚îÇ    existingSession = clients.get("abc123-...") ‚îÇ
‚îÇ    ‚Üê Session retrouv√©e !                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 9. Serveur envoie state_sync                  ‚îÇ
‚îÇ    Tous les fichiers/id√©es restaur√©s           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 10. CLIENT RECONNECT√â SEAMLESSLY ‚úÖ           ‚îÇ
‚îÇ     Aucune perte d'√©tat                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Points Cl√©s** :
- ‚úÖ `persistentClientId` : **IDENTIQUE**
- ‚úÖ `sessionId` : **IDENTIQUE** (pas de reboot)
- üîÑ Socket : **NOUVELLE** (reconnexion r√©seau)
- ‚úÖ √âtat : **100% RESTAUR√â** (seamless)

---

## 8. DIAGRAMME COMPLET

### 8.1 Relations Entre Tous les IDs

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    CLIENT APPLICATION                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ Persistent Client ID (QSettings)                ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ "3f8c7d2a-5b1e-4f6d-9a2c-1b3d4e5f6g7h"         ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ ‚Üì STABLE - survit aux red√©marrages              ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ                       ‚îÇ                                       ‚îÇ
‚îÇ                       ‚îÇ setPersistentClientId()               ‚îÇ
‚îÇ                       ‚ñº                                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ WebSocketClient                                 ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ m_persistentClientId (stock√©)               ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ m_sessionId (g√©n√©r√© au d√©marrage)           ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ   "abc123-def456-ghi789-jkl012"              ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ   ‚Üë √âPH√âM√àRE - change √† chaque lancement     ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ m_clientId (re√ßu du serveur)                ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ                       ‚îÇ                                       ‚îÇ
‚îÇ                       ‚îÇ register(persistentId, sessionId)     ‚îÇ
‚îÇ                       ‚ñº                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
                       ‚îÇ WebSocket
                       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      ‚ñº                   SERVER               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  ‚îÇ clients Map<sessionId, ClientInfo>           ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ   "abc123-..." ‚Üí {                            ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     id: "abc123-...",                         ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     sessionId: "abc123-...",                  ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     persistentId: "3f8c7d2a-...", ‚Üê LI√â       ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     ws: [WebSocket],                          ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     machineName: "MacBook Pro"                ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ   }                                           ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  ‚îÇ sessionsByPersistent Map                      ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ   "3f8c7d2a-..." ‚Üí Set(["abc123-..."])       ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ   ‚Üë Permet de retrouver toutes les sessions  ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     d'un m√™me client persistant               ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  ‚îÇ clientFiles Map (tracking fichiers)          ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ   "3f8c7d2a-..." ‚Üí Map(                      ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     "idea-001" ‚Üí Set(["file-xyz", "file-abc"]) ‚îÇ          ‚îÇ
‚îÇ  ‚îÇ     "idea-002" ‚Üí Set(["file-def"])            ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ   )                                           ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    CLIENT - CANVAS SIDE                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  ‚îÇ SessionManager                                ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ   Map<persistentClientId, CanvasSession>      ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ                                                ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ   "3f8c7d2a-..." ‚Üí CanvasSession {            ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     persistentClientId: "3f8c7d2a-...",       ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     ideaId: "idea-001",  ‚Üê Une id√©e par canvas‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     canvas: [ScreenCanvas widget],            ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     expectedIdeaFileIds: Set([...]),          ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     knownRemoteFileIds: Set([...])            ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ   }                                           ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ                       ‚îÇ                                       ‚îÇ
‚îÇ                       ‚îÇ canvas contient                       ‚îÇ
‚îÇ                       ‚ñº                                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  ‚îÇ Media Items (QGraphicsScene)                 ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ                                               ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ   ResizableMediaBase {                       ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     m_mediaId: "aaa111"  ‚Üê UUID unique item  ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     m_fileId: "xyz789"   ‚Üê Hash chemin       ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     m_sourcePath: "/path/to/chat.jpg"        ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ   }                                           ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ                                               ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ   ResizableMediaBase {                       ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     m_mediaId: "bbb222"  ‚Üê UUID diff√©rent    ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     m_fileId: "xyz789"   ‚Üê M√äME fileId !     ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     m_sourcePath: "/path/to/chat.jpg"        ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ   }                                           ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ                       ‚îÇ                                       ‚îÇ
‚îÇ                       ‚îÇ lookup via FileManager                ‚îÇ
‚îÇ                       ‚ñº                                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  ‚îÇ FileManager                                   ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ   LocalFileRepository:                        ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     Map<fileId, path>                         ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     "xyz789" ‚Üí "/path/to/chat.jpg"            ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ                                               ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ   RemoteFileTracker:                          ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     Map<fileId, Set<clientIds>>               ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     "xyz789" ‚Üí Set(["3f8c7d2a-..."])         ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ                                               ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ   Associations:                               ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     Map<mediaId, fileId>                      ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     "aaa111" ‚Üí "xyz789"                       ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     "bbb222" ‚Üí "xyz789"                       ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ                                               ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     Map<fileId, Set<ideaIds>>                 ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ     "xyz789" ‚Üí Set(["idea-001", "idea-002"]) ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### 8.2 Flux Upload Complet avec Tous les IDs

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PR√âPARATION UPLOAD                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Client A (sender)                                  Server
persistentId: "aaa111"
sessionId: "session-A"
                                                   
Canvas pour Client B (target):
persistentId: "bbb222"  ‚Üê Target
ideaId: "idea-001"

Items sur canvas:
  - media1: mediaId "mmm111" ‚Üí fileId "fff777" (chat.jpg)
  - media2: mediaId "mmm222" ‚Üí fileId "fff888" (dog.jpg)
  - media3: mediaId "mmm333" ‚Üí fileId "fff777" (chat.jpg, doublon)

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ √âTAPE 1 : Build Manifest (d√©duplication)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

processedFileIds = Set()

Pour chaque media:
  ‚úì media1: fileId "fff777" ‚Üí Ajouter (premier)
  ‚úó media2: fileId "fff888" ‚Üí Ajouter
  ‚úó media3: fileId "fff777" ‚Üí SKIP (d√©j√† dans processedFileIds)

R√©sultat : 2 fichiers √† uploader (pas 3 !)

manifest = [
  {
    fileId: "fff777",
    mediaId: "mmm111",  ‚Üê Premier media trouv√© avec ce fichier
    name: "chat.jpg",
    size: 1024000
  },
  {
    fileId: "fff888",
    mediaId: "mmm222",
    name: "dog.jpg",
    size: 2048000
  }
]

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ √âTAPE 2 : Upload Start                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Client A ‚Üí Server:
{
  type: "upload_start",
  targetClientId: "bbb222",  ‚Üê persistentId du target
  uploadId: "upload-xyz123",  ‚Üê UUID unique de cet upload
  ideaId: "idea-001",         ‚Üê Obligatoire !
  filesManifest: [...]
}

Server re√ßoit:
- Cr√©e tracking: uploads.set("upload-xyz123", {
    sender: "aaa111",
    target: "bbb222",
    ideaId: "idea-001",
    files: ["fff777", "fff888"],
    startTime: Date.now()
  })

Server ‚Üí Client B:
{
  type: "upload_start",
  senderClientId: "aaa111",
  uploadId: "upload-xyz123",
  ideaId: "idea-001",
  filesManifest: [...]
}

Client B:
- Cr√©e dossier cache pour uploadId
- Pr√©pare fichiers vides pour chaque fileId

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ √âTAPE 3 : Upload Chunks                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Pour chaque fichier, pour chaque chunk:

Client A ‚Üí Server:
{
  type: "upload_chunk",
  targetClientId: "bbb222",
  uploadId: "upload-xyz123",
  fileId: "fff777",      ‚Üê Identifie le fichier
  chunkIndex: 0,
  data: "base64...",
  ideaId: "idea-001"
}

Server ‚Üí Client B: (relay direct)
{
  type: "upload_chunk",
  senderClientId: "aaa111",
  uploadId: "upload-xyz123",
  fileId: "fff777",
  chunkIndex: 0,
  data: "base64...",
  ideaId: "idea-001"
}

Client B:
- √âcrit chunk dans fichier
- Calcule progress
- Envoie feedback au sender

Client B ‚Üí Server:
{
  type: "upload_progress",
  senderClientId: "aaa111",
  uploadId: "upload-xyz123",
  percent: 45,
  filesCompleted: 1,
  totalFiles: 2,
  completedFileIds: ["fff777"],  ‚Üê Premier fichier termin√©
  perFileProgress: {
    "fff777": 100,
    "fff888": 0
  }
}

Server ‚Üí Client A: (relay)
{...m√™me message...}

Client A re√ßoit:
- Met √† jour UI globale: "Uploading (1/2) 45%"
- Met √† jour items individuels:
    * media1 (fileId fff777): 100% ‚úÖ
    * media2 (fileId fff888): 0%
    * media3 (fileId fff777): 100% ‚úÖ (m√™me fichier que media1!)

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ √âTAPE 4 : Upload Complete                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Client A ‚Üí Server:
{
  type: "upload_complete",
  targetClientId: "bbb222",
  uploadId: "upload-xyz123",
  ideaId: "idea-001"
}

Server:
- R√©cup√®re upload: uploads.get("upload-xyz123")
- Met √† jour clientFiles:
  
  clientFiles.get("bbb222").get("idea-001") = Set([
    "fff777",  ‚Üê Ajout√©
    "fff888"   ‚Üê Ajout√©
  ])

- Supprime tracking upload temporaire
- Relay au target

Server ‚Üí Client B:
{
  type: "upload_complete",
  senderClientId: "aaa111",
  uploadId: "upload-xyz123",
  ideaId: "idea-001"
}

Client B:
- V√©rifie tous les fichiers re√ßus
- Envoie confirmation finale

Client B ‚Üí Server:
{
  type: "upload_finished",
  senderClientId: "aaa111",
  uploadId: "upload-xyz123"
}

Server ‚Üí Client A: (relay)
{...m√™me message...}

Client A:
- Marque tous les items comme "Uploaded"
- media1: √âtat = Uploaded ‚úÖ
- media2: √âtat = Uploaded ‚úÖ
- media3: √âtat = Uploaded ‚úÖ (m√™me fileId que media1)

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ R√âSULTAT FINAL                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Client A (sender):
  FileManager associations:
    - fileId "fff777" ‚Üí clients: ["bbb222"]
    - fileId "fff888" ‚Üí clients: ["bbb222"]
    - fileId "fff777" ‚Üí ideaIds: ["idea-001"]
    - fileId "fff888" ‚Üí ideaIds: ["idea-001"]

Server tracking:
  clientFiles.get("bbb222") = {
    "idea-001": Set(["fff777", "fff888"])
  }

Client B (target):
  Cache files:
    - /cache/upload-xyz123/fff777 (chat.jpg)
    - /cache/upload-xyz123/fff888 (dog.jpg)
  
  FileManager:
    - Registered: fff777 ‚Üí /cache/.../fff777
    - Registered: fff888 ‚Üí /cache/.../fff888

‚úÖ 2 fichiers physiques upload√©s
‚úÖ 3 media items marqu√©s comme uploaded
‚úÖ D√©duplication r√©ussie (chat.jpg upload√© 1 fois, pas 2)
```

---

## 9. CAS D'USAGE CRITIQUES

### 9.1 Multi-Instance sur M√™me Machine

**Question** : Comment g√©rer 2 instances de Mouffette sur le m√™me Mac ?

**R√©ponse** :

```bash
# Terminal 1 - Instance principale (default)
$ ./MouffetteClient.app/Contents/MacOS/MouffetteClient

# Terminal 2 - Instance "dev"
$ MOUFFETTE_INSTANCE_SUFFIX=dev1 ./MouffetteClient.app/Contents/MacOS/MouffetteClient

# Terminal 3 - Instance "test"
$ ./MouffetteClient.app/Contents/MacOS/MouffetteClient --instance-suffix=test1
```

**R√©sultat** :
```
Instance 1:
  persistentId: "uuid-aaa111" (cl√©: persistentClientId_MacBookPro_a1b2c3d4)
  sessionId: "session-111"

Instance 2:
  persistentId: "uuid-bbb222" (cl√©: persistentClientId_MacBookPro_a1b2c3d4_dev1)
  sessionId: "session-222"

Instance 3:
  persistentId: "uuid-ccc333" (cl√©: persistentClientId_MacBookPro_a1b2c3d4_test1)
  sessionId: "session-333"
```

**Serveur voit** : 3 clients compl√®tement distincts et ind√©pendants.

---

### 9.2 R√©cup√©ration Apr√®s Crash

**Sc√©nario** : Client crash pendant un upload

**√âtat Avant Crash** :
```
Server clientFiles:
  "client-aaa111": {
    "idea-001": Set(["file-xyz", "file-abc"])  ‚Üê Fichiers pr√©sents
  }
```

**Que se passe-t-il ?**

1. **Client redemarre**
   - M√™me `persistentId` (r√©cup√©r√© depuis QSettings)
   - Nouveau `sessionId` (g√©n√©r√© au boot)

2. **Reconnexion**
   ```
   Client ‚Üí Server: register(persistentId, nouveau sessionId)
   ```

3. **Server detecte le client connu**
   ```javascript
   const persistentId = message.clientId; // "client-aaa111"
   // Trouve les fichiers existants
   const ideas = this.clientFiles.get(persistentId);
   ```

4. **Server envoie state_sync**
   ```json
   {
     "type": "state_sync",
     "ideas": {
       "idea-001": ["file-xyz", "file-abc"]
     }
   }
   ```

5. **Client restaure l'√©tat**
   ```cpp
   // MainWindow::handleStateSyncFromServer()
   for (const QString& fileId : ideaFileIds) {
       session->knownRemoteFileIds.insert(fileId);
   }
   // Tous les items marqu√©s comme "Uploaded" ‚úÖ
   ```

**R√©sultat** : Aucune perte de donn√©es, √©tat 100% restaur√©.

---

### 9.3 Upload M√™me Fichier Vers 2 Clients

**Sc√©nario** : Vous uploadez `chat.jpg` vers Client B et Client C

**Canvas A (vers Client B)** :
```
ideaId: "idea-001"
media1: mediaId "mmm111" ‚Üí fileId "fff777" (chat.jpg)
```

**Canvas B (vers Client C)** :
```
ideaId: "idea-002"
media2: mediaId "mmm222" ‚Üí fileId "fff777" (chat.jpg, M√äME fileId !)
```

**Upload 1 (vers Client B)** :
```
upload_start ‚Üí targetClientId: "bbb222", ideaId: "idea-001", fileId: "fff777"
...chunks...
upload_complete

Server:
  clientFiles.get("bbb222").get("idea-001") = Set(["fff777"])
```

**Upload 2 (vers Client C)** :
```
upload_start ‚Üí targetClientId: "ccc333", ideaId: "idea-002", fileId: "fff777"
...chunks...
upload_complete

Server:
  clientFiles.get("ccc333").get("idea-002") = Set(["fff777"])
```

**FileManager (Client A)** :
```cpp
RemoteFileTracker:
  fileId "fff777" ‚Üí clients: Set(["bbb222", "ccc333"])

IdeaAssociations:
  fileId "fff777" ‚Üí ideaIds: Set(["idea-001", "idea-002"])
```

**R√©sultat** :
- ‚úÖ M√™me fichier upload√© 2 fois (unavoidable, 2 destinations diff√©rentes)
- ‚úÖ Tracking correct par client ET par ideaId
- ‚úÖ Si vous supprimez media1, fichier reste pour media2

---

### 9.4 Suppression Fichier Unique Parmi Doublons

**Setup** :
```
Canvas (ideaId "idea-001"):
  media1: mediaId "mmm111" ‚Üí fileId "fff777" (chat.jpg, position A)
  media2: mediaId "mmm222" ‚Üí fileId "fff777" (chat.jpg, position B, doublon)
  media3: mediaId "mmm333" ‚Üí fileId "fff888" (dog.jpg)
```

**Action** : Supprimer media1 (premier chat.jpg)

**Code** :
```cpp
// MediaSettingsPanel - Delete button clicked
FileManager::removeMediaAssociation(mediaId);
```

**Dans FileManager** :
```cpp
void FileManager::removeMediaAssociation(const QString& mediaId) {
    QString fileId = m_mediaIdToFileId.value(mediaId);
    
    // Supprime l'association media ‚Üí file
    m_mediaIdToFileId.remove(mediaId);
    
    // Supprime de la liste file ‚Üí medias
    QList<QString>& mediaIds = m_fileIdToMediaIds[fileId];
    mediaIds.removeAll(mediaId);
    
    // Si plus aucun media ne r√©f√©rence ce fichier
    if (mediaIds.isEmpty()) {
        m_fileIdToMediaIds.remove(fileId);
        removeFileIfUnused(fileId);  ‚Üê Cleanup complet
    }
}
```

**R√©sultat pour ce cas** :
```
Apr√®s suppression de media1:
  m_fileIdToMediaIds["fff777"] = ["mmm222"]  ‚Üê media2 reste !
  
  ‚Üí removeFileIfUnused() n'est PAS appel√©
  ‚Üí Fichier fff777 reste dans le syst√®me
  ‚Üí media2 continue d'afficher chat.jpg ‚úÖ
```

**Si on supprime AUSSI media2** :
```
Apr√®s suppression de media2:
  m_fileIdToMediaIds["fff777"] = []  ‚Üê Plus de r√©f√©rences
  
  ‚Üí removeFileIfUnused() EST appel√©
  ‚Üí Notify serveur pour supprimer chez tous les clients
  ‚Üí Fichier fff777 compl√®tement supprim√©
```

---

## 10. R√âSUM√â EX√âCUTIF

### Table de Correspondance Rapide

| ID Type | G√©n√©ration | Dur√©e de Vie | Scope | Exemple |
|---------|-----------|--------------|-------|---------|
| **Persistent Client ID** | 1 fois (QSettings) | Permanent | Installation | `3f8c7d2a-5b1e-4f6d-9a2c` |
| **Session ID** | Chaque boot | Temporaire | Processus | `abc123-def456-ghi789` |
| **Media ID** | Par item canvas | Item lifetime | Canvas local | `mmm111`, `mmm222` |
| **File ID** | SHA256 path | Fichier lifetime | Fichier physique | `fff777` (hash de /path/chat.jpg) |
| **Idea ID** | Par canvas | Canvas lifetime | Canvas/Sc√®ne | `idea-001` |

### Questions Fr√©quentes

**Q1 : Pourquoi 2 IDs client (persistent + session) ?**
- **Persistent** : Identit√© stable pour tracking √† long terme
- **Session** : Tracking connexion r√©seau temporaire pour gestion reconnexion

**Q2 : Pourquoi media ID ET file ID ?**
- **Media ID** : Item graphique unique sur canvas (position, taille, √©tat)
- **File ID** : Fichier physique unique (d√©duplication, upload)
- Plusieurs media items peuvent partager le m√™me file (copies sur canvas)

**Q3 : Comment le serveur sait que c'est le m√™me client apr√®s reboot ?**
- Le client envoie toujours le m√™me `persistentClientId` (lu depuis QSettings)
- Server fusion automatiquement les sessions bas√© sur ce persistentId

**Q4 : Que se passe-t-il si je d√©place un fichier ?**
- Nouveau `fileId` g√©n√©r√© (hash bas√© sur le chemin)
- Ancien fileId n'est plus valide
- Upload n√©cessaire si le fichier a √©t√© upload√© pr√©c√©demment

**Q5 : Puis-je avoir plusieurs clients sur la m√™me machine ?**
- Oui, utiliser `MOUFFETTE_INSTANCE_SUFFIX=dev1` ou `--instance-suffix=test1`
- Chaque instance a son propre `persistentClientId` unique

---

## 11. SCH√âMA DE D√âCISION

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Quel ID utiliser pour...                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚ùì Identifier un CLIENT de mani√®re stable ?
   ‚Üí Persistent Client ID
   Exemples : client_list, state_sync, tracking uploads

‚ùì Tracker une CONNEXION r√©seau sp√©cifique ?
   ‚Üí Session ID
   Exemples : fusion sessions, reconnexion seamless

‚ùì Identifier un ITEM GRAPHIQUE sur le canvas ?
   ‚Üí Media ID
   Exemples : selection UI, progress bars individuelles

‚ùì Identifier un FICHIER PHYSIQUE (d√©duplication) ?
   ‚Üí File ID
   Exemples : manifeste upload, tracking fichiers upload√©s

‚ùì Identifier une SC√àNE/PROJET sur un canvas ?
   ‚Üí Idea ID
   Exemples : associations fichiers, state sync par sc√®ne

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Relations Cl√©s                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1 Persistent Client ID ‚Üí N Session IDs (dans le temps)
1 Persistent Client ID ‚Üí N Canvas Sessions (un par client distant)
1 Canvas Session ‚Üí 1 Idea ID
1 Idea ID ‚Üí N File IDs (fichiers sur ce canvas)
1 File ID ‚Üí N Media IDs (items dupliqu√©s sur canvas)
1 Media ID ‚Üí 1 File ID (mais plusieurs medias ‚Üí m√™me file OK)
```

---

**FIN DU RAPPORT**

Ce document constitue la r√©f√©rence compl√®te pour comprendre tous les syst√®mes d'identification dans Mouffette. Pour toute question ou clarification, r√©f√©rez-vous aux sections pertinentes ci-dessus.
